<!DOCTYPE html>
<html>
<head>
<title>XRX++ Unit Tests - xrx.update</title>
<script src='../../lib/closure-library/closure/goog/base.js'></script>
<script type="text/javascript" src="../../lib/jssaxparser/LocatorImpls.js"></script>
<script type="text/javascript" src="../../lib/jssaxparser/NamespaceSupport.js"></script>
<script type="text/javascript" src="../../lib/jssaxparser/sax.js"></script>
<script type="text/javascript" src="../../lib/jssaxparser/DefaultHandlers.js"></script>
<script src='../deps.js'></script>
<script type="text/javascript">
  goog.require('goog.dom');
  goog.require('goog.testing.jsunit');
  goog.require('xrx.instance');
  goog.require('xrx.pilot');
  goog.require('xrx.token');
  goog.require('xrx.token.StartTag');
  goog.require('xrx.token.EndTag');
  goog.require('xrx.token.EmptyTag');
  goog.require('xrx.update');
</script>
</head>
<body>
<script type="text/javascript">

var xml;
var element;
var instance;

var xmlNs;
var elementNs;
var instanceNs;

function resetForNextTest() {
  xml = undefined;
  xml = '<a>test<b>2</b>3<c attr1="test" attr2="">4<d/>55<e/></c><f/></a>';
  element = undefined;
  element = goog.dom.createElement('div');
  goog.dom.setTextContent(element, xml);
  instance = undefined;
  instance = new xrx.instance(element);

  xmlNs = undefined;
  xmlNs = '<x><y/><a xmlns="http://www.example.org/a"><b:b xmlns:b="http://www.example.org/b"><c/></b:b></a></x>';
  elementNs = undefined;
  elementNs = goog.dom.createElement('div');
  goog.dom.setTextContent(elementNs, xmlNs);
  instanceNs = undefined;
  instanceNs = new xrx.instance(elementNs);
};

function test01wrap() {
  resetForNextTest();
  
  // basic
  var expected = '<a><bb>test<b>2</b></bb>3<c attr1="test" attr2="">4<d/>55<e/></c><f/></a>';
  var t1Left = instance.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,0])));
  var t1Rigth = instance.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,1])));
    
  //with offset
  
  //empty not-tag tokens
};

function test01_NsDefault_wrap() {
  //namespace already defined
  
  //namespace not defined
};

function test01_NsPrefix_wrap() {
  //namespace already defined
  
  //namespace not defined
};

function test02replaceNotTag() {
  resetForNextTest();
  
  // replace a value with another but shorter value
  var expected1 = '<a>1<b>2</b>3<c attr1="test" attr2="">4<d/>55<e/></c><f/></a>';
  var t1 = instance.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,0])));
  xrx.update.replaceNotTag(instance, t1, '1');
  assertEquals(expected1, instance.xml());
  
  // replace a value with another but longer value
  var expected2 = '<a>testtest<b>2</b>3<c attr1="test" attr2="">4<d/>55<e/></c><f/></a>';
  var t2 = instance.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,0])));
  xrx.update.replaceNotTag(instance, t2, 'testtest');
  assertEquals(expected2, instance.xml());
  
  // replace a value with the empty string
  var expected3 = '<a>testtest<b></b>3<c attr1="test" attr2="">4<d/>55<e/></c><f/></a>';
  var t3 = instance.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,1,0])));
  xrx.update.replaceNotTag(instance, t3, '');
  assertEquals(expected3, instance.xml());
  
  // replace a empty not-tag token with a value
  var expected4 = '<a>testtest<b></b>3<c attr1="test" attr2="">4<d/>55<e/></c><f/>new</a>';
  var t4 = instance.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,3])));
  xrx.update.replaceNotTag(instance, t4, 'new');
  assertEquals(expected4, instance.xml());
};

function test03replaceTagName() {
  //TODO
};

function test04replaceAttrValue() {
  resetForNextTest();

  // replace a value with another but longer value
  var expected1 = '<a>test<b>2</b>3<c attr1="test" attr2="test">4<d/>55<e/></c><f/></a>';
  var t1 = instance.getPilot().location(null, new xrx.token.AttrValue(new xrx.label([1,2,2])));
  xrx.update.replaceAttrValue(instance, t1, 'test');
  assertEquals(expected1, instance.xml());

  // replace a value with another but shorter value
  var expected2 = '<a>test<b>2</b>3<c attr1="" attr2="test">4<d/>55<e/></c><f/></a>';
  var t2 = instance.getPilot().location(null, new xrx.token.AttrValue(new xrx.label([1,2,1])));
  xrx.update.replaceAttrValue(instance, t2, '');
  assertEquals(expected2, instance.xml());
};

function test05insertEmptyTag() {
  resetForNextTest();

  // start-tag, offset 0
  var expected1 = '<a><x/>test<b>2</b>3<c attr1="test" attr2="">4<d/>55<e/></c><f/></a>';
  var t1 = instance.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,0])));
  xrx.update.insertEmptyTag(instance, t1, 0, 'x');
  assertEquals(expected1, instance.xml());
  
  // end-tag, at end of not-tag
  var expected2 = '<a><x/>test<b>2</b>3<x/><c attr1="test" attr2="">4<d/>55<e/></c><f/></a>';
  var t2 = instance.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,2])));
  xrx.update.insertEmptyTag(instance, t2, 1, 'x');
  assertEquals(expected2, instance.xml());
  
  // empty tag, with offset
  var expected3 = '<a><x/>test<b>2</b>3<x/><c attr1="test" attr2="">4<d/>5<x/>5<e/></c><f/></a>';
  var t3 = instance.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,4,1])));
  xrx.update.insertEmptyTag(instance, t3, 1, 'x');
  assertEquals(expected3, instance.xml());
};

function test05_Ns_insertEmptyTag() {
  resetForNextTest();

  // default namespace
  var expected1 = '<x><y/><a xmlns="http://www.example.org/a"><b:b xmlns:b="http://www.example.org/b"><c/><y/></b:b></a></x>';
  var t1 = instanceNs.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,2,1,1])));
  xrx.update.insertEmptyTag(instanceNs, t1, 0, 'y', 'http://www.example.org/a');
  assertEquals(expected1, instanceNs.xml());

  // namespace with prefix
  var expected2 = '<x><y/><a xmlns="http://www.example.org/a"><b:b xmlns:b="http://www.example.org/b"><c/><b:y/><y/></b:b></a></x>';
  xrx.update.insertEmptyTag(instanceNs, t1, 0, 'y', 'http://www.example.org/b');
  assertEquals(expected2, instanceNs.xml());

  // undefined namespace
  var expected3 = '<x><y/><a xmlns="http://www.example.org/a"><b:b xmlns:b="http://www.example.org/b">' + 
      '<c/><y xmlns="http://www.example.org/c"/><b:y/><y/></b:b></a></x>';
  xrx.update.insertEmptyTag(instanceNs, t1, 0, 'y', 'http://www.example.org/c');
  assertEquals(expected3, instanceNs.xml());
};

function test06insertStartEndTag() {
  resetForNextTest();

  // start-tag, offset 0
  var expected1 = '<a><x></x>test<b>2</b>3<c attr1="test" attr2="">4<d/>55<e/></c><f/></a>';
  var t1 = instance.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,0])));
  xrx.update.insertStartEndTag(instance, t1, 0, 'x');
  assertEquals(expected1, instance.xml());
  
  // end-tag, at end of not-tag
  var expected2 = '<a><x></x>test<b>2</b>3<x></x><c attr1="test" attr2="">4<d/>55<e/></c><f/></a>';
  var t2 = instance.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,2])));
  xrx.update.insertStartEndTag(instance, t2, 1, 'x');
  assertEquals(expected2, instance.xml());
  
  // empty tag, with offset
  var expected3 = '<a><x></x>test<b>2</b>3<x></x><c attr1="test" attr2="">4<d/>5<x></x>5<e/></c><f/></a>';
  var t3 = instance.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,4,1])));
  xrx.update.insertStartEndTag(instance, t3, 1, 'x');
  assertEquals(expected3, instance.xml());
};

function test06_Ns_insertStartEndTag() {
  resetForNextTest();

  // default namespace
  var expected1 = '<x><y/><a xmlns="http://www.example.org/a"><b:b xmlns:b="http://www.example.org/b"><c/><y></y></b:b></a></x>';
  var t1 = instanceNs.getPilot().location(null, new xrx.token.NotTag(new xrx.label([1,2,1,1])));
  xrx.update.insertStartEndTag(instanceNs, t1, 0, 'y', 'http://www.example.org/a');
  assertEquals(expected1, instanceNs.xml());

  // namespace with prefix
  var expected2 = '<x><y/><a xmlns="http://www.example.org/a"><b:b xmlns:b="http://www.example.org/b"><c/><b:y></b:y><y></y></b:b></a></x>';
  xrx.update.insertStartEndTag(instanceNs, t1, 0, 'y', 'http://www.example.org/b');
  assertEquals(expected2, instanceNs.xml());

  // undefined namespace
  var expected3 = '<x><y/><a xmlns="http://www.example.org/a"><b:b xmlns:b="http://www.example.org/b">' + 
      '<c/><y xmlns="http://www.example.org/c"></y><b:y></b:y><y></y></b:b></a></x>';
  xrx.update.insertStartEndTag(instanceNs, t1, 0, 'y', 'http://www.example.org/c');
  assertEquals(expected3, instanceNs.xml());
};

</script>
</body>
</html>
