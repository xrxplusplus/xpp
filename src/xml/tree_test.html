<!DOCTYPE html>
<html>
<head>
<title>XRX++ Unit Tests - xrx.tree</title>
<script src='../../lib/closure-library/closure/goog/base.js'></script>
<script src='../deps.js'></script>
<script type="text/javascript">
  goog.require('goog.array');
  goog.require('goog.testing.jsunit');
  goog.require('xrx.label');
  goog.require('xrx.tree');
</script>
</head>
<body>
<script type="text/javascript">

function test01forward() {
  // possible combinations
  //
  // start start
  // start empty
  // start end
  // empty start
  // empty empty
  // empty end
  // end start
  // end empty
  // end end
  var xml = '<start><empty/><empty/><start><start></end></end><start><empty/></end><start></end><empty/></end>';
  //         [1]    [1,1]   [1,2]   [1,3]  [1,3,1][1,3,1][1,3][1,4]  [1,4,1] [1,4] [1,5]  [1,5] [1,6]   [1]
  var test = {
    0:  [1],
    1:  [1,1],
    2:  [1,2],
    3:  [1,3],
    4:  [1,3,1],
    5:  [1,3,1],
    6:  [1,3],
    7:  [1,4],
    8:  [1,4,1],
    9:  [1,4],
    10: [1,5],
    11: [1,5],
    12: [1,6],
    13: [1]
  };
  var labels = [];
  var tree = new xrx.tree(xml);

  tree.rowStartTag = function(label) {
    labels.push(label);
  };

  tree.rowEndTag = function(label) {
    labels.push(label);
  };

  tree.rowEmptyTag = function(label) {
    labels.push(label);
  };

  // test forward
  tree.forward();
  for (var i = 0; i <= 13; i++) {
    assertTrue(new xrx.label(test[i]).sameAs(labels[i]));
  }
};

function test02backward() {
  // Backward is only useful for the parent, ancestor and preceding-sibling axes
  // possible combinations
  //
  // start start
  // start empty
  // start end
  // empty start
  // empty empty
  // empty end
  // end start
  // end empty
  // end end
  var xml = '<start><empty/><empty/><start><start></end><empty/><start><empty/></end></end></end>';
  //         [1]    [1,1]   [1,2]   [1,3]  [1,3,1][1,3,1][1,3,2][1,3,3][1,3,3,1][1,3,3][1,3][1]
  var test = {
    0:  [1],
    1:  [1,1],
    2:  [1,2],
    3:  [1,3],
    4:  [1,3,1],
    5:  [1,3,1],
    6:  [1,3,2],
    7:  [1,3,3],
    8:  [1,3,3,1],
    9:  [1,3,3],
    10: [1,3],
    11: [1]
  };
  var labels = [];
  var tree = new xrx.tree(xml);

  tree.rowStartTag = function(label, offset, length) {
    labels.push(label);
    console.log(xml.substr(offset, length));
  };

  tree.rowEndTag = function(label, offset, length) {
    labels.push(label);
    console.log(xml.substr(offset, length));
  };

  tree.rowEmptyTag = function(label, offset, length) {
    labels.push(label);
    console.log(xml.substr(offset, length));
  };

  // test backward
  tree.backward(new xrx.label([1,3,3]), 79);
  console.log(labels);
  for (var i = 9; i >= 0; i--) {
    assertTrue(new xrx.label(test[i]).sameAs(labels[i]));
  }
};

function test03offsetStartTag() {
  var xml = '<test><a></a></test>';
  var tree = new xrx.tree(xml);
  var endLabels = [];

  tree.rowStartTag = function(label) {
  };

  tree.rowEndTag = function(label) {
    endLabels.push(label);
  };

  tree.rowEmptyTag = function(label) {
  };

  tree.forward(new xrx.label([1, 1]), 5);

  assertEquals(2, endLabels.length);
  assertTrue(endLabels[0].sameAs(new xrx.label([1, 1])));
  assertTrue(endLabels[1].sameAs(new xrx.label([1])));
};

function test04offsetEmptyTag() {
  var xml = '<test><a/></test>';
  var tree = new xrx.tree(xml);
  var endLabels = [];

  tree.rowStartTag = function(label) {
  };

  tree.rowEndTag = function(label) {
    endLabels.push(label);
  };

  tree.rowEmptyTag = function(label) {
  };

  tree.forward(new xrx.label([1, 1]), 5);

  assertEquals(1, endLabels.length);
  assertTrue(endLabels[0].sameAs(new xrx.label([1])));
};

function test05offsetEndTag() {
  var xml = '<test><a></a></test>';
  var tree = new xrx.tree(xml);
  var endLabels = [];

  tree.rowStartTag = function(label) {
  };

  tree.rowEndTag = function(label) {
    endLabels.push(label);
  };

  tree.rowEmptyTag = function(label) {
  };

  tree.forward(new xrx.label([1]), 12);

  assertEquals(1, endLabels.length);
  assertTrue(endLabels[0].sameAs(new xrx.label([1])));
};

function test06features() {
  var xml = '<test attr1="v1" attr2="v2"' + 
      ' xmlns:a="http://example.org/a"' + 
      ' xmlns:b="http://example.org/b"></test>';
  var tree = new xrx.tree(xml);
  tree.setFeatures(true);
  tree.setFeature('ATTRIBUTE', false);
  
  var tagNames = [];
  var attributes = [];
  var attrNames = [];
  var attrValues = [];
  var namespaces = [];
  var nsPrefixes = [];
  var nsUris = [];

  tree.rowStartTag = function() {};
  tree.rowEndTag = function() {};
  tree.rowEmptyTag = function() {};
  tree.eventTagName = function(label) {
    tagNames.push(label.clone());
  };
  tree.eventAttribute = function(label) {
    attributes.push(label.clone());
  };
  tree.eventAttrName = function(label) {
    attrNames.push(label.clone());
  };
  tree.eventAttrValue = function(label) {
    attrValues.push(label.clone());
  };
  tree.eventNamespace = function(label) {
    namespaces.push(label.clone());
  };
  tree.eventNsPrefix = function(label) {
    nsPrefixes.push(label.clone());
  };
  tree.eventNsUri = function(label) {
    nsUris.push(label.clone());
  };
  
  tree.forward();
  tree.backward();
  
  assertTrue(tagNames[0].sameAs(new xrx.label([1])));
  assertTrue(tagNames[1].sameAs(new xrx.label([1])));
  assertTrue(tagNames[3].sameAs(new xrx.label([1])));

  assertTrue(attributes[0].sameAs(new xrx.label([1, 1])));
  assertTrue(attributes[1].sameAs(new xrx.label([1, 2])));

  assertTrue(attrNames[0].sameAs(new xrx.label([1, 1])));
  assertTrue(attrNames[1].sameAs(new xrx.label([1, 2])));

  assertTrue(attrValues[0].sameAs(new xrx.label([1, 1])));
  assertTrue(attrValues[1].sameAs(new xrx.label([1, 2])));

  assertTrue(namespaces[0].sameAs(new xrx.label([1, 1])));
  assertTrue(namespaces[1].sameAs(new xrx.label([1, 2])));

  assertTrue(nsPrefixes[0].sameAs(new xrx.label([1, 1])));
  assertTrue(nsPrefixes[1].sameAs(new xrx.label([1, 2])));

  assertTrue(nsUris[0].sameAs(new xrx.label([1, 1])));
  assertTrue(nsUris[1].sameAs(new xrx.label([1, 2])));
};

</script>
</body>
</html>
